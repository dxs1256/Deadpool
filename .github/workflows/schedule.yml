name: Proxy Checker

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  check_proxies:
    runs-on: ubuntu-latest
    
    # 授予写权限，以便提交代码
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: master

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests toml pysocks

      - name: Run proxy checker
        run: python main.py

      - name: Commit changes
        uses: actions/github-script@v6
        with:
          script: |
            const { execSync } = require('child_process');
            const currentTime = new Date().toISOString();

            // 1. 设置 Git 用户
            execSync('git config --local user.email "action@github.com"');
            execSync('git config --local user.name "GitHub Action"');

            // 2. 添加所有变更 (包括 Baidu.txt, Google.txt, All.txt)
            execSync('git add .');

            // 3. 提交 (使用 try-catch 忽略无变更时的报错)
            try {
                execSync(`git commit -m "Update proxy list at ${currentTime}"`);
                console.log("提交成功，准备推送...");
            } catch (error) {
                console.log("没有检测到文件变动 (No changes to commit)，跳过推送。");
                return; 
            }

            // 4. 推送
            execSync('git push origin master');
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
